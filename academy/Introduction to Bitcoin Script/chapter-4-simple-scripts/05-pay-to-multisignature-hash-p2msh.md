# 05 - Pay to MultiSignature Hash (P2MSH)

| Stack                                                                                                             | Script                                                                                                                                                                                                                                                                           | Description                                              |
| ----------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------- |
| Empty.                                                                                                            | 1 \<signature\_1> \<signature\_2> \<pubkey\_1> \<pubkey\_2> \<pubkey\_3> \| \|OP\_3DUP OP\_CAT OP\_CAT OP\_HASH160 <3pubkey\_hash> OP\_EQUALVERIFY OP\_TOALTSTACK OP\_TOALTSTACK OP\_TOALTSTACK OP\_2 OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_3 OP\_CHECKMULTISIG | scriptSig and scriptPubKey are combined.                 |
| 1 \<signature\_1> \<signature\_2> \<pubkey\_1> \<pubkey\_2> \<pubkey\_3>                                          | OP\_3DUP OP\_CAT OP\_CAT OP\_HASH160 <3pubkey\_hash> OP\_EQUALVERIFY OP\_TOALTSTACK OP\_TOALTSTACK OP\_TOALTSTACK OP\_2 OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_3 OP\_CHECKMULTISIG                                                                               | Signatures and public keys are added to the stack        |
| 1 \<signature\_1> \<signature\_2> \<pubkey\_1> \<pubkey\_2> \<pubkey\_3>\<pubkey\_1> \<pubkey\_2> \<pubkey\_3>    | OP\_CAT OP\_CAT OP\_HASH160 <3pubkey\_hash> OP\_EQUALVERIFY OP\_TOALTSTACK OP\_TOALTSTACK OP\_TOALTSTACK OP\_2 OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_3 OP\_CHECKMULTISIG                                                                                        | 3 public keys are duplicated                             |
| 1 \<signature\_1> \<signature\_2> \<pubkey\_1> \<pubkey\_2> \<pubkey\_3>\<pubkey\_1> \<pubkey\_2\_3\_cat>         | OP\_CAT OP\_HASH160 <3pubkey\_hash> OP\_EQUALVERIFY OP\_TOALTSTACK OP\_TOALTSTACK OP\_TOALTSTACK OP\_2 OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_3 OP\_CHECKMULTISIG                                                                                                | Pubkey 2 and Pubkey 3 are concatenated                   |
| 1 \<signature\_1> \<signature\_2> \<pubkey\_1> \<pubkey\_2> \<pubkey\_3>\<pubkey\_1\_2\_3\_cat>                   | OP\_HASH160 <3pubkey\_hash> OP\_EQUALVERIFY OP\_TOALTSTACK OP\_TOALTSTACK OP\_TOALTSTACK OP\_2 OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_3 OP\_CHECKMULTISIG                                                                                                        | Pubkey 1 is concatenated with Pukey 2\_3 concatenation   |
| 1 \<signature\_1> \<signature\_2> \<pubkey\_1> \<pubkey\_2> \<pubkey\_3> \<pubkey\_1\_2\_3\_hash>                 | <3pubkey\_hash> OP\_EQUALVERIFY OP\_TOALTSTACK OP\_TOALTSTACK OP\_TOALTSTACK OP\_2 OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_3 OP\_CHECKMULTISIG                                                                                                                    | Concatenated pubkeys are double hashed using OP\_HASH160 |
| 1 \<signature\_1> \<signature\_2> \<pubkey\_1> \<pubkey\_2> \<pubkey\_3> \<pubkey\_1\_2\_3\_hash> <3pubkey\_hash> | OP\_EQUALVERIFY OP\_TOALTSTACK OP\_TOALTSTACK OP\_TOALTSTACK OP\_2 OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_3 OP\_CHECKMULTISIG                                                                                                                                    | Expected 3 pubkey hash is pushed onto the stack          |
| 1 \<signature\_1> \<signature\_2> \<pubkey\_1> \<pubkey\_2> \<pubkey\_3>                                          | OP\_TOALTSTACK OP\_TOALTSTACK OP\_TOALTSTACK OP\_2 OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_3 OP\_CHECKMULTISIG                                                                                                                                                    | Generated hash is evaluated against expected hash        |
| 1 \<signature\_1> \<signature\_2>​Altstack:\<pubkey\_3> \<pubkey\_2> \<pubkey\_1>                                 | OP\_2 OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_3 OP\_CHECKMULTISIG                                                                                                                                                                                                 | Pubkeys 3, 2 and 1 are pushed to altstack                |
| 1 \<signature\_1> \<signature\_2> 2​Altstack:\<pubkey\_3> \<pubkey\_2> \<pubkey\_1>                               | OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_FROMALTSTACK OP\_3 OP\_CHECKMULTISIG                                                                                                                                                                                                       | Constant value '2' is pushed onto the stack              |
| 1 \<signature\_1> \<signature\_2> 2 \<pubkey\_1>\<pubkey\_2>\<pubkey\_3>                                          | OP\_3 OP\_CHECKMULTISIG                                                                                                                                                                                                                                                          | Pubkeys 3, 2 and 1 are pulled from altstack              |
| 1 \<signature\_1> \<signature\_2> 2 \<pubkey\_1>\<pubkey\_2>\<pubkey\_3> 3                                        | OP\_CHECKMULTISIG                                                                                                                                                                                                                                                                | Constant value '3' is pushed onto the stack              |
| true                                                                                                              | Empty.                                                                                                                                                                                                                                                                           | Multisignature evaluation is performed                   |

<figure><img src="../.gitbook/assets/BSVA-BitcoinScript_Chapter4-Animation05 V1.gif" alt=""><figcaption></figcaption></figure>

As shown above, the spending parties must supply 2 valid signatures and the three public keys that correspond to the hash stored in the output. The 3 public keys are duplicated and hashed using the OP\_HASH160 opcode, and the resultant data item is checked against a hash value stored in the output.

Following this, the three public keys are pushed to the ALTSTACK so that the 2 signature evaluation criteria can be inserted, and then pulled back to the main stack. The 3 pubkey evaluation criteria is then added and the multisig operation takes place.

These types of scripts can be applied in many ways to enable multi-party collaboration for a range of use cases.
